var Infinitum=function(){"use strict";function t(t,e){this.defaults={debug:!1,template:"#item-template",container:"body",contentClass:"",spinnerClass:"loader",messageClass:"message",sourceAttr:"data-load",dataPath:"data",nextPagePath:"next_page",totalPagesPath:"total_pages",offset:0,endMessage:"No more items to load...",animation:null,waitForImages:!1},this.options=$.extend({},this.defaults,t),this.map=e,this.template=this.getTemplateContent(),this.container=this.getContainer(),this.placeholderNames=this.getPlaceholderNames(),this.content=this.insertContent(),this.spinner=this.insertSpinner(),this.message=this.insertMessage(),this.scrollHelper=this.insertScrollHelper(),this.nextPage=this.parseSource(),this.totalPages=0,this.page=0,this.loading=!1,this.canLoad=!0,this.bindEvents(),this.check()}return t.prototype.bindEvents=function(){$(window).on("scroll",this.check.bind(this)),this.container.on("infinitum:scrolled-in",this.onScrolledIn.bind(this)),this.container.on("infinitum:loaded",this.onLoaded.bind(this)),this.container.on("infinitum:end",this.onEnd.bind(this))},t.prototype.getContainer=function(){return $(this.options.container)},t.prototype.parseSource=function(){return this.container.attr(this.options.sourceAttr)},t.prototype.insertContent=function(){var t=$("<div>");return t.addClass(this.options.contentClass),this.container.append(t),t},t.prototype.insertScrollHelper=function(){var t=$("<div>");return this.container.append(t),t},t.prototype.insertSpinner=function(){var t=$("<div>");return t.addClass(this.options.spinnerClass),t.hide(),this.container.append(t),t},t.prototype.insertMessage=function(){var t=$("<div>");return t.addClass(this.options.messageClass),t.hide(),this.container.append(t),t},t.prototype.check=function(){if(this.canLoad){var t=this.isInView(this.scrollHelper);!this.loading&&t&&this.container.trigger("infinitum:scrolled-in")}},t.prototype.isInView=function(t){var e=t.offset().top,n=$(window).height(),i=$(window).scrollTop();return e-i>0&&e-i<n-this.options.offset},t.prototype.load=function(){this.loading=!0,this.nextPage&&void 0!==this.nextPage||this.container.trigger("infinitum:end"),$.ajax({url:this.nextPage,dataType:"json",success:function(t){this.renderResponse(t),this.parseNextPage(t),this.parseTotalPages(t),this.container.trigger("infinitum:loaded")}.bind(this),error:function(t){this.showMessage("Error: ("+t.status+") "+t.statusText)}.bind(this)})},t.prototype.renderResponse=function(t){var e=this.parseResponse(t);if(void 0===e)return void this.showMessage("Response cannot be parsed");if(!Array.isArray(e))return void this.showMessage("Response data must be an array");try{this.render(e)}catch(n){this.showMessage(n)}},t.prototype.parseResponse=function(t){return this.getProperty(t,this.options.dataPath)},t.prototype.parseData=function(t){var e=this,n={};return this.placeholderNames.forEach(function(i){var s=e.map[i];if(void 0===s)throw"Map is missing a property that is defined in the template";n[i]=e.getProperty(t,s)}),n},t.prototype.parseNextPage=function(t){this.nextPage=this.getProperty(t,this.options.nextPagePath)},t.prototype.parseTotalPages=function(t){0===this.totalPages&&(this.totalPages=this.getProperty(t,this.options.totalPagesPath))},t.prototype.onScrolledIn=function(){this.load(),this.spinner.show()},t.prototype.onLoaded=function(){this.spinner.hide(),this.loading=!1,this.page++,this.page>=this.totalPages&&this.container.trigger("infinitum:end")},t.prototype.onEnd=function(){this.showMessage(this.options.endMessage)},t.prototype.render=function(t){var e=this;t.forEach(function(t){try{var n=e.parseData(t)}catch(i){throw"Cannot render template: "+i}var s=e.renderTemplate(n),o=e.appendItem(s);e.animate(o)})},t.prototype.animate=function(t){if(this.options.animation){var e=this.options.animation+"-enter";return t.addClass(this.options.animation),t.addClass(e),this.options.waitForImages?void t.find("img").one("load",function(){t.removeClass(e)}):void setTimeout(function(){t.removeClass(e)},0)}},t.prototype.appendItem=function(t){return $(t).appendTo(this.content)},t.prototype.getTemplateContent=function(){var t=$(this.options.template),e=t.html();return t.remove(),e},t.prototype.renderTemplate=function(t){var e=this.template;return this.placeholderNames.forEach(function(n){var i=new RegExp("{{ *"+n+" *}}","g");e=e.replace(i,t[n])}),e},t.prototype.getPlaceholderNames=function(){for(var t=[],e=/{{ *([a-zA-Z0-9_]+) *}}/g,n=e.exec(this.template);null!=n;)t.push(n[1]),n=e.exec(this.template);return t},t.prototype.showMessage=function(t){this.options.debug?this.message.text(t):this.message.text(this.options.endMessage),this.message.text()&&this.message.show(),this.spinner.hide(),this.canLoad=!1},t.prototype.getProperty=function(t,e){for(var n=e.split("."),i=0,s=n.length;null!=t&&s>i;)t=t[n[i++]];return i&&i==s?t:void 0},t}();